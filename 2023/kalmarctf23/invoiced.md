+ Given the source, we have three main files, app.js, payment.js and pdf.js. After we enter the necessary details and the discount coupen code, we will get the bill in a pdf. 
+ We have the following endpoints in app.js
  - /cart 
  - /orders -
  - /checkout: validates the discount code submitted in a form, calculates the total price, and redirects to a payment URL generated by the payments module. If the total price is zero, it generates a PDF invoice using the pdf module and sends it as a response.
  - /renderInvoice: It has CSP 
  - /orders: It checks that the request is coming from localhost and that no bot cookie is set, and sends a flag (or a test flag) as a response.
+ Payment.js:
  - getpaymentURL: cartId parameter, but it always throws an error with the message "Payment Processor is down due to ransomware. Please try again later"
  - validateDiscount: takes a discountCode parameter and returns a discount rate as a decimal between 0 and 1. The function looks up the discount code in an object called discountCodes, which maps codes to discount rates. If the code is found, the corresponding rate is returned. If the code is not found, the nullish coalescing operator ?? returns 0 as the default discount rate
+ pdf.js:
  - renderPDF function: uses Puppeteer, a Node.js library for controlling a headless Chrome or Chromium browser, to render an HTML invoice and generate a PDF file.
  - The function then navigates to the /renderInvoice route with query parameters generated from the body object using the querystring module. The waitUntil: 'networkidle0' option tells Puppeteer to wait until there are no more than 0 network connections for at least 500 ms before considering the page loaded.
  
 ```
let total = 414

  if (total * (1 - discountRate)> 0) {
    try {
      return res.redirect(payments.getPaymentURL(id))
    } catch (e) {
      res.statusCode = 500
      return res.send(e.message)
    }
  }
  ```
  The above calculation set the total amount to be 414.  The discountRate is obtained by passing the discount code submitted by the user to the validateDiscount function, which returns a decimal representing the percentage discount (e.g., 0.1 for a 10% discount).
  If amt to be paid>0:  redirect the user to a payment URL generated using the getPaymentURL function, passing in a randomly generated UUID as the cartId
  If amt to be paid<=0: the code generates a PDF invoice by calling the renderPdf function, passing in the request body (which presumably includes information about the user's purchase and contact information). The resulting PDF is sent to the user as a response.
  
### Solving

+ Cannot use script tag because of script src
+ Using meta refresh tag:
    -Tried this not working:  a</title><meta http-equiv="Refresh" content="0; url='http://localhost:5000/orders'" />
    - Note there is check in /orders: 
 ```
app.get('/orders', (req, res) => {
  if (req.socket.remoteAddress != "::ffff:127.0.0.1") {
    return res.send("Nice try")
  }
  ```

It checks whether the request came from 127.0.0.1, just change the origin address and the final payload looks like this:
```a</title><meta http-equiv="Refresh" content="0; url='http://127.0.0.1:5000/orders'" />```
Flag: `kalmar{fr33_r34l_3st4t3_c91ad62}`

Conclusion:
+ #HTML Injection
+ we forced a server-side redirection to arbitrary endpoint. PDF parser took the contents of that endoint and put it inside the PDF. 


